name: Build and Release Alpine Package

on:
  push:
    tags:
      - '*'

permissions:
  contents: write
  packages: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Install Alpine in Docker
        uses: addnab/docker-run-action@v3
        with:
          image: alpine:latest
          options: -v ${{ github.workspace }}:/workspace
          run: |
            apk update
            apk add gcc libc-dev curl-dev cjson-dev abuild fakeroot

            # Set version from tag (strip leading 'v')
            export RELEASE_VERSION="${GITHUB_REF#refs/tags/v}"

            # Build binary
            cd /workspace
            gcc aslookup.c -o aslookup -lcurl -lcjson -lresolv

            # Prepare APKBUILD
            mkdir -p /workspace/alpinepkg
            cd /workspace/alpinepkg
            cat <<EOF > APKBUILD
            # Contributor: Niel Nielsen <nieldk@hmail.com>
            pkgname=aslookup
            pkgver=$RELEASE_VERSION
            pkgrel=1
            pkgdesc=\"ASN lookup utility\"
            url=\"https://github.com/nieldk/aslookup\"
            arch=\"x86_64\"
            license=\"MIT\"
            depends=\"libc6 curl cjson\"
            source=\"aslookup\"
            builddir=\"$PWD\"
            package() {
              install -Dm755 \$srcdir/aslookup \$pkgdir/usr/local/bin/aslookup
            }
            EOF

            # Move binary to build dir
            cp /workspace/aslookup .

            # Build .apk package
            abuild-keygen -a -n
            abuild -r

            # Find the built .apk file
            APK_FILE=$(find /workspace/alpinepkg -name \"*.apk\" | head -n 1)
            cp \"$APK_FILE\" /workspace/aslookup_${RELEASE_VERSION}_x86_64.apk

      - name: Upload .apk to release
        uses: softprops/action-gh-release@v2
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: aslookup_${{ env.RELEASE_VERSION }}_x86_64.apk
        env:
          GITHUB_TOKEN: ${{ secrets.GH_PAT }}
