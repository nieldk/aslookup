name: Alpine Build and APK Release

on:
  push:
    tags:
      - '*'

permissions:
  contents: write
  packages: write

jobs:
  build:
    # Use a standard runner, but execute all steps inside an Alpine container
    runs-on: ubuntu-latest
    container:
      image: alpine:latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Build Dependencies (Alpine) ðŸ› ï¸
        # Use 'apk add' instead of 'apt-get install'.
        # 'build-base' provides essential tools like GCC.
        # 'curl-dev' and 'jansson-dev' provide libcurl and a popular JSON library.
        # 'apk-tools' provides the 'apk' command to build the package.
        run: |
          apk update
          apk add --no-cache build-base curl-dev jansson-dev

      - name: Set version from tag
        run: echo "RELEASE_VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_ENV

      - name: Build binary
        # Note: I'm assuming 'libcjson' in the original project can be replaced
        # with 'jansson' which is commonly available on Alpine repos. 
        run: gcc aslookup.c -o aslookup -lcurl -ljansson -lresolv

      - name: Prepare APK package structure
        # The structure for an APK package is similar, placing files 
        # in the expected directories.
        run: |
          # Create the final installation directory structure
          mkdir -p pkg/usr/local/bin
          cp aslookup pkg/usr/local/bin/

          # APK packages don't use a separate DEBIAN/control file.
          # The package metadata is generated via 'apk add' or 'abuild'.
          # For a simpler approach, we'll manually use the directory structure.

      - name: Create the APK package
        # Since 'apk-tools' is installed, we can use the 'apk' command to 
        # create the package from the staged directory.
        run: |
          # Add a simple .PKGINFO file with core metadata (not strictly required 
          # by this simple approach but good practice).
          echo "pkgname = aslookup" > pkg/.PKGINFO
          echo "pkgver = $RELEASE_VERSION" >> pkg/.PKGINFO
          echo "maintainer = Niel Nielsen <nieldk@gmail.com>" >> pkg/.PKGINFO
          echo "url = https://github.com/nieldk/aslookup" >> pkg/.PKGINFO

          # Build the APK file
          cd pkg
          tar -czf control.tar.gz .PKGINFO # Control metadata
          tar -czf data.tar.gz usr/ # File contents
          
          # Create the final APK file (combining control and data)
          apk create --description "ASN lookup utility" --install-if "libc6, libcurl4, libjansson" aslookup_${RELEASE_VERSION}_x86_64.apk

      - name: Upload .apk to release
        uses: softprops/action-gh-release@v2
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: pkg/aslookup_${{ env.RELEASE_VERSION }}_x86_64.apk
        env:
          GITHUB_TOKEN: ${{ secrets.GH_PAT }}
